<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebAuthn Device-Binding Demo</title>
  <style>
    body  { font-family: system-ui, sans-serif; margin: 2rem; }
    button{ margin-right: 1rem; padding: 0.5rem 1rem; }
    #log  { border: 1px solid #ccc; padding: 0.75rem; margin-top: 1rem;
            white-space: pre-wrap; background: #f9f9f9; height: 220px; overflow: auto; }
  </style>
</head>

<body>
  <h1>WebAuthn Device Binding Demo</h1>
  <p>
    This page registers a <strong>resident passkey</strong> on your device and prints the base64-URL
    credential ID.<br>
    Open it in <em>any</em> browser on the same device and click <strong>Authenticate</strong>; it
    should succeed, proving the key is device-wide.
  </p>

  <button id="register">Register&nbsp;Passkey</button>
  <button id="authenticate">Authenticate</button>

  <pre id="log"></pre>

  <script type="module">
    /* ---------- helpers: base64url encode/decode ---------- */
    function b64u(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }
    function u8(b64) {
      const pad = "=".repeat((4 - (b64.length % 4)) % 4);
      const b64s = (b64 + pad).replace(/-/g, "+").replace(/_/g, "/");
      return Uint8Array.from(atob(b64s), c => c.charCodeAt(0));
    }

    /* ---------- tiny local-storage ‚Äúbackend‚Äù ---------- */
    const STORE_KEY = "demo_passkey";
    const logEl = document.getElementById("log");
    const log = (...a) => (logEl.textContent += a.map(String).join(" ") + "\n");

    /* ---------- register passkey ---------- */
    document.getElementById("register").addEventListener("click", async () => {
      try {
        const cred = await navigator.credentials.create({
          publicKey: {
            rp: { name: "Device Bind Demo" },
            user: {
              id: crypto.getRandomValues(new Uint8Array(16)),
              name: "device",
              displayName: "device"
            },
            pubKeyCredParams: [{ alg: -7, type: "public-key" }], // ES256
            authenticatorSelection: {
              authenticatorAttachment: "platform",
              residentKey: "required",
              userVerification: "preferred"
            },
            challenge: crypto.getRandomValues(new Uint8Array(32))
          }
        });

        const credId = b64u(cred.rawId);
        localStorage.setItem(STORE_KEY, credId);
        log("‚úÖ Registered credential ID:", credId);
      } catch (err) {
        log("‚ùå Registration error:", err);
      }
    });

    /* ---------- authenticate ---------- */
    document.getElementById("authenticate").addEventListener("click", async () => {
      const credIdB64 = localStorage.getItem(STORE_KEY);
      if (!credIdB64) return log("‚ö†Ô∏è No credential found. Register first.");

      try {
        await navigator.credentials.get({
          publicKey: {
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            allowCredentials: [{ id: u8(credIdB64), type: "public-key" }],
            userVerification: "preferred"
          }
        });
        log("üéâ Authentication successful for credential:", credIdB64);
      } catch (err) {
        log("‚ùå Authentication error:", err);
      }
    });
  </script>
</body>
</html>
